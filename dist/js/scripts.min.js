"use strict";
var xhr, monJSON, monJSONComplet, catBtnArr, searchType = document.querySelectorAll(".search-container div"),
    searchTypeArr = Array.from(searchType),
    browser = document.querySelector("#browser"),
    itemWrap = document.querySelector(".item-wrap"),
    itemCount = document.querySelector(".item-count"),
    pager = document.querySelector(".pager"),
    baseUrl = "http://localhost:8888/04-shop/js_shop-bdd/",
    nameInput = document.querySelector(".nom input"),
    priceInputsArr = Array.from(document.querySelectorAll(".prix input")),
    checkboxInputsArr = Array.from(document.querySelectorAll(".categorie input")),
    p = document.querySelector(".tq-resultat"),
    cartIcon = document.querySelector(".cart-icon"),
    cartPanel = document.querySelector(".cart-panel"),
    cross = document.querySelector(".cross"),
    buyBtn = document.querySelector(".buy-btn"),
    delBtn = Array.from(document.querySelectorAll(".del-btn")),
    qtyItemBtn = document.querySelector(".cart-items input"),
    cartWrap = document.querySelector(".cart-wrap"),
    cart = [],
    min = 0,
    max = 1e3,
    articleByPage = 5;

function ajaxFunction(e) {
    200 == e.status && 4 == e.readyState && (monJSON = (monJSON = JSON.parse(e.responseText)).result, null == monJSONComplet && (monJSONComplet = monJSON), setPages(0))
}

function callAjax() {
    var e = 0 < arguments.length && void 0 !== arguments[0] ? arguments[0] : "",
        t = baseUrl + "api.php";
    (xhr = new XMLHttpRequest).addEventListener("readystatechange", function() {
        ajaxFunction(this)
    }), xhr.open("POST", t, !0), xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded"), xhr.send(e)
}

function setUrl(e, t, n) {
    var a;
    switch (e) {
        case "name":
            a = "query=like&name=".concat(t);
            break;
        case "price":
            a = "query=priceRange&min=".concat(t, "&max=").concat(n);
            break;
        case "cat":
            a = "query=category&category=".concat(t);
            break;
        default:
            alert("something wrong happened")
    }
    cleanItem(), callAjax(a)
}

function addItem(e) {
    var t = Number(e.currentTarget.dataset.id),
        e = cart.findIndex(function(e) {
            return e.id == t
        }); - 1 != e ? cart[e].quantity++ : cart.push({
        id: t,
        quantity: 1
    }), updateCart()
}

function updateCart() {
    cartWrap.innerHTML = "";
    var c = 0,
        i = 0;
    cart.forEach(function(t, e) {
        var n = document.createElement("DIV");
        n.classList.add("cart-item");
        var a = monJSONComplet.findIndex(function(e) {
            return e.id == t.id
        });
        n.innerHTML = "\n        <article>\n            <p>".concat(monJSONComplet[a].name, "</p>\n        </article>\n        <span>").concat(monJSONComplet[a].price, "€</span>\n        ");
        var r = document.createElement("INPUT");
        r.setAttribute("type", "number"), r.setAttribute("min", "1"), r.value = t.quantity, r.dataset.indextoupdate = e, r.addEventListener("input", updateQuantity), n.appendChild(r);
        r = document.createElement("BUTTON");
        r.classList.add("del-btn"), r.textContent = "X", r.dataset.indextodelete = e, r.addEventListener("click", removeFromCart), n.appendChild(r), cartWrap.appendChild(n), i += monJSONComplet[a].price * t.quantity, 0 < (c += t.quantity) && (itemCount.innerHTML = c, itemCount.style.display = "flex", itemCount.style.animation = "bounceIn", itemCount.style.animationDuration = ".5s", itemCount.addEventListener("animationend", function() {
            itemCount.style.animation = "none"
        }))
    });
    var e = document.createElement("P");
    e.classList.add("total"), e.textContent = "Total : " + i.toFixed(2) + "€", cartWrap.appendChild(e)
}

function removeFromCart(e) {
    e = Number(e.currentTarget.dataset.indexasupprimer);
    cart.splice(e, 1), updateCart()
}

function updateQuantity(e) {
    var t = Number(e.currentTarget.dataset.indextoupdate);
    cart[t].quantity = e.currentTarget.value, updateCart()
}

function nameSearch() {
    13 == event.keyCode && (setUrl("name", String(nameInput.value)), p.innerHTML = " Résultats pour : " + String(nameInput.value), nameInput.value = "", nameInput.blur())
}

function priceSearch(e) {
    console.log(e.target.name, e.target.value), "price-min" == e.target.name && (min = e.target.value, document.querySelector('.prix [for="price-min"]').textContent = min + " €"), "price-max" == e.target.name && (max = e.target.value, document.querySelector('.prix [for="price-max"]').textContent = max + " €"), min < max && (null != min || null != max) && setUrl("price", min, max)
}

function catSearch(e) {
    "change" == e.type ? e.target.checked && (console.log("je suis la"), setUrl("cat", e.target.value)) : "submit" == e.type && (console.log("hello", e.innerText), setUrl("cat", e.innerText))
}

function searchChoice() {
    searchTypeArr.forEach(function(e) {
        e.classList.contains(browser.value) ? e.style.display = "flex" : (e.style.display = "none", "" == browser.value && (cleanItem(), callAjax()))
    })
}

function initItems() {
    callAjax()
}

function cleanItem() {
    itemWrap.innerHTML = "", pager.innerHTML = ""
}

function buildItem(e) {
    var t = document.createElement("div");
    t.innerHTML = '<div class="item" id="item'.concat(e.id, '">\n            <div class="item-pic">\n                <img class="item-img" src="').concat(baseUrl, "assets/").concat(e.id, '.jpg" alt="img">\n            </div>\n            <div class="item-text">\n                <h4 class="item-name">').concat(e.name, '</h4>\n                <p class="item-desc">').concat(e.description, '</p>\n                <button class="item-cat">').concat(e.category, '</button>\n            </div>\n            <div class="item-details">\n                <p class="item-price">').concat(e.price, '€</p>\n                <button class="add-item-btn">Add to cart</button>\n            </div>\n        </div>'), itemWrap.appendChild(t);
    t = document.querySelector("#item".concat(e.id, " .add-item-btn"));
    t.dataset.id = e.id, t.addEventListener("click", addItem)
}

function buildBtn(n) {
    for (var e = Math.ceil(monJSON.length / articleByPage), t = 0; t < e; t++) ! function(t) {
        var e = document.createElement("BUTTON");
        e.classList.add("page-btn"), e.textContent = t + 1, e.dataset.offset = t, e.dataset.offset == n && (e.style.backgroundColor = "black", e.style.color = "yellow"), e.addEventListener("click", function(e) {
            setPages(t)
        }), pager.appendChild(e)
    }(t)
}

function setCatResearch() {
    (catBtnArr = Array.from(document.querySelectorAll(".item-cat"))).forEach(function(e) {
        e.addEventListener("click", function() {
            catSearch(e)
        })
    })
}

function setPages() {
    var e = 0 < arguments.length && void 0 !== arguments[0] ? arguments[0] : monJSON.length;
    cleanItem(), buildBtn(e);
    for (var e = e * articleByPage, t = e + articleByPage > monJSON.length ? monJSON.length : e + articleByPage, n = e; n < t; n++) buildItem(monJSON[n]);
    setCatResearch()
}

function toggleCartPanel() {
    cartPanel.classList.toggle("show"), cartIcon.classList.toggle("hide")
}
browser.addEventListener("change", searchChoice), nameInput.addEventListener("keyup", nameSearch), priceInputsArr.forEach(function(e) {
    e.addEventListener("input", function(e) {
        priceSearch(e)
    })
}), checkboxInputsArr.forEach(function(e) {
    e.addEventListener("change", function(e) {
        catSearch(e)
    })
}), cartIcon.addEventListener("click", toggleCartPanel), cross.addEventListener("click", toggleCartPanel), buyBtn.addEventListener("click", function() {
    alert("Vous avez bien tout acheté ça arrive mardi ;P"), location.reload()
});